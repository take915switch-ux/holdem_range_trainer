<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>とけいクイズ ⏰</title>
<style>
  :root{
    --bg:#f8fafc;
    --panel:#ffffff;
    --ink:#0f172a;
    --muted:#6b7280;
    --accent:#22c55e;
    --accent-2:#3b82f6;
    --wrong:#ef4444;
    --ring:#e2e8f0;
    --shadow: 0 10px 25px rgba(15,23,42,.08);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{ min-height:100%; }           /* height:100% → min-height:100% 推奨 */
body{
  font-family: ...;
  margin:0;
  background:linear-gradient(180deg,#f1f5f9,#f8fafc);
  color:var(--ink);
  /* display:flex; align-items:center; justify-content:center; ←削除 */
  padding:24px;
	
  }
	/* 小さい画面では通常の縦流しにする */
@media (max-width:820px){
  body{ display:block; padding:12px; }
  .app{ width:min(100%,980px); margin:0 auto; }
}
	
  .app{
    width:min(100%,980px);
    background:var(--panel);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:20px;
  }
  header{
    display:flex; align-items:center; gap:12px; justify-content:space-between; flex-wrap:wrap;
    border-bottom:1px solid var(--ring); padding-bottom:12px; margin-bottom:16px;
		
		position: sticky;
  top: env(safe-area-inset-top, 0);
  background: var(--panel);
  z-index: 10;
  padding-top: max(12px, env(safe-area-inset-top, 0));
		
  }
  .brand{font-weight:800; font-size:20px; letter-spacing:.02em; display:flex; align-items:center; gap:8px}
  .brand span{font-size:24px}
  .controls{display:flex; gap:10px; flex-wrap:wrap}
  button, select{
    border:1px solid var(--ring); background:#fff; border-radius:12px; padding:10px 14px; font-weight:700;
    cursor:pointer; transition:transform .05s ease, box-shadow .2s ease, border-color .2s ease;
  }
  button:active{transform:translateY(1px)}
  .primary{background:var(--accent-2); color:#fff; border-color:transparent}
  .ghost{background:#fff}
  .pill{border-radius:999px}
  .stats{
    display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; margin:10px 0 4px;
  }
  .stat{
    background:#f9fafb; border:1px solid var(--ring); border-radius:14px; padding:10px 12px;
    display:flex; flex-direction:column; gap:2px; text-align:center;
  }
  .stat .label{color:var(--muted); font-size:12px}
  .stat .value{font-size:18px; font-weight:800}
  .question{
    display:grid; grid-template-columns:1fr; gap:14px; margin-top:8px;
  }
  .prompt{
    background:#f1f5f9; border:1px dashed var(--ring); border-radius:14px; padding:14px;
    display:flex; align-items:center; justify-content:center; gap:10px; font-size:20px; font-weight:800;
  }
  .prompt .time{
    background:#fff; padding:8px 14px; border-radius:10px; border:1px solid var(--ring);
    box-shadow: inset 0 1px 0 rgba(0,0,0,.02);
    font-size:28px;
  }
  .choices{
  display:grid; gap:14px;
  /* もとの repeat(4, 1fr) をやめて、可変カラムに */
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  }
  @media (max-width:820px){
    .choices{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  }
  .card{
    position:relative; background:#fff; border:2px solid var(--ring); border-radius:16px; padding:12px;
    display:flex; flex-direction:column; align-items:center; gap:8px; cursor:pointer; transition:border-color .2s ease, transform .05s ease, box-shadow .2s ease;
  }
  .card:active{ transform: translateY(1px); }
  .card.correct{ border-color: var(--accent); box-shadow: 0 0 0 4px rgba(34,197,94,.15); }
  .card.wrong{ border-color: var(--wrong); box-shadow: 0 0 0 4px rgba(239,68,68,.15); }
  .badge{
    position:absolute; top:8px; left:8px; background:#f1f5f9; border:1px solid var(--ring); border-radius:999px; padding:4px 8px;
    font-size:12px; color:var(--muted)
  }
  canvas{ width:100%; height:auto; aspect-ratio:1 / 1; display:block }
  .progress{
    height:10px; background:#eef2f7; border-radius:999px; overflow:hidden; border:1px solid var(--ring); margin-top:8px;
  }
  .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--accent-2),#60a5fa); transition:width .35s ease}
  .footer{
    margin-top:14px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }
  .helper{color:var(--muted); font-size:14px}
  .toast{
    position:fixed; inset:auto 16px 16px auto; background:#111827; color:#fff; padding:10px 14px; border-radius:12px; box-shadow: var(--shadow);
    font-weight:700; opacity:0; transform:translateY(10px); transition:all .25s ease;
  }
  .toast.show{ opacity:1; transform:translateY(0) }
  .sr-only{ position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
</style>
</head>
<body>
  <div class="app" role="application" aria-label="とけいクイズ">
    <header>
      <div class="brand"><span>⏰</span> とけいクイズ</div>
      <div class="controls">
        <label for="difficulty" class="sr-only">難易度</label>
				<select id="difficulty" title="難易度をえらぶ">
  <option value="zero">かんたん（00分のみ）</option>
  <option value="zero30">かんたん（00分・30分のみ）</option><!-- ←追加 -->
  <option value="easy">やさしい（5分刻み）</option>
  <option value="normal" selected>ふつう（5分刻み＋ひっかけ）</option>
  <option value="hard">むずかしい（1分刻み）</option>
</select>
				
				
        <button id="newRound" class="ghost pill">あたらしく 10問</button>
        <button id="resetBest" class="ghost pill">ベストスコアをけす</button>
        <button id="howto" class="primary pill">あそびかた</button>
      </div>
    </header>

    <section class="stats" aria-live="polite">
      <div class="stat"><div class="label">スコア</div><div id="score" class="value">0</div></div>
      <div class="stat"><div class="label">れんぞく</div><div id="streak" class="value">0</div></div>
      <div class="stat"><div class="label">まちがい</div><div id="miss" class="value">0</div></div>
      <div class="stat"><div class="label">ベスト</div><div id="best" class="value">0</div></div>
    </section>

    <div class="progress" aria-hidden="true"><div id="bar" class="bar"></div></div>

    <main class="question">
      <div class="prompt" id="prompt" aria-live="polite">
        <span>この じこくは どれ？</span>
        <span class="time" id="timeText" aria-label="出題じこく">--じ--ふん</span>
      </div>

      <section class="choices" id="choices" role="list" aria-label="こたえ を えらぶ"></section>

      <div class="footer">
        <div class="helper">カードをタップ（または 1・2・3・4 キー）で こたえよう！</div>
        <button id="next" class="primary pill" disabled>つぎの もんだい ▶</button>
      </div>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  // ==== 設定値 ====
  const ROUND_QUESTIONS = 10;
  const POINT_BASE = 10;
  const POINT_STREAK = 2; // 連続正解ボーナス/問
  const PENALTY_WRONG = 5;

  // ==== 状態 ====
  let state = {
    qIndex: 0,
    score: 0,
    streak: 0,
    miss: 0,
    best: Number(localStorage.getItem("clock.best") || 0),
    difficulty: localStorage.getItem("clock.diff") || "normal",
    current: null, // {h,m}
    options: []    // [{h,m},... 4つ]
  };

  // ==== ユーティリティ ====
  const byId = id => document.getElementById(id);
  const fmt = (h,m) => `${h}じ${m.toString().padStart(2,"0")}ふん`;
  const clamp = (min,v,max)=>Math.max(min,Math.min(max,v));

  // 分を 0-59 に正規化しつつ時も調整
  function normalize(h,m){
    h = ((h % 12) + 12) % 12; if(h===0) h=12;
    while(m<0){ m+=60; h=(h===1?12:h-1); }
    while(m>=60){ m-=60; h=(h===12?1:h+1); }
    return {h,m};
  }

  // ランダム整数 [a,b]
  const rnd = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;

  // 難易度に応じて時刻を作る
	function randomTime(diff){
  const hour = rnd(1,12);
  let minute;
  if(diff==="zero"){
    minute = 0; // 00分固定
  } else if(diff==="zero30"){
    minute = Math.random() < 0.5 ? 0 : 30; // 00 or 30
  } else if(diff==="easy"){
    const steps=[0,5,10,15,20,25,30,35,40,45,50,55];
    minute = steps[rnd(0,steps.length-1)];
  } else if(diff==="normal"){
    const pool = [];
    for(let m=0;m<60;m+=5){ pool.push(m); if([0,15,30,45].includes(m)) pool.push(m); }
    minute = pool[rnd(0,pool.length-1)];
  } else {
    minute = rnd(0,59); // hard
  }
  return {h:hour, m:minute};
}
	
	
  // ひっかけ選択肢をつくる
	function makeOptions(answer, diff){
  // 特別ルール：00・30のみモードでは、選択肢は「別の時刻の00か30」だけ
  if(diff==="zero30"){
    const opts = [answer];
    const used = new Set([`${answer.h}:${answer.m}`]);
    while(opts.length < 4){
      const h = rnd(1,12);
      if(h === answer.h) continue; // 別の時刻
      const m = Math.random()<0.5 ? 0 : 30;
      const key = `${h}:${m}`;
      if(!used.has(key)){
        used.add(key);
        opts.push({h, m});
      }
    }
    // シャッフル
    for(let i=opts.length-1;i>0;i--){
      const j=rnd(0,i);
      [opts[i],opts[j]]=[opts[j],opts[i]];
    }
    return opts;
  }

  // ↑以外の難易度は従来どおり
  const opts = [answer];
  const used = new Set([`${answer.h}:${answer.m}`]);

  const deltasEasy = [5,10,15, -5, -10, -15, 60, -60];
  const deltasNormal = [2,3,5,7,10,12,15, -2,-3,-5,-7,-10,-12,-15, 60, -60];
  const deltasHard = [1,2,3,4,5,6,7,8,10,12,15,-1,-2,-3,-4,-5,-6,-7,-8,-10,-12,-15];

  const deltas = diff==="easy" ? deltasEasy : (diff==="normal" ? deltasNormal : deltasHard);

  while(opts.length<4){
    const delta = deltas[rnd(0,deltas.length-1)];
    const alt = normalize(answer.h, answer.m + delta);
    const key = `${alt.h}:${alt.m}`;
    if(!used.has(key)){
      used.add(key);
      opts.push(alt);
    }
  }
  for(let i=opts.length-1;i>0;i--){
    const j=rnd(0,i);
    [opts[i],opts[j]]=[opts[j],opts[i]];
  }
  return opts;
}

  // ==== 描画：アナログ時計 ====
  function drawClock(canvas, h, m){
    const ctx = canvas.getContext("2d");
    const size = Math.min(canvas.width, canvas.height);
    const r = size/2;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();
    ctx.translate(r, r);

    // 盤面
    ctx.beginPath();
    ctx.arc(0,0,r-6,0,Math.PI*2);
    ctx.fillStyle = "#fff";
    ctx.fill();
    ctx.lineWidth = 4;
    ctx.strokeStyle = "#e5e7eb";
    ctx.stroke();

    // 目盛り
    for(let i=0;i<60;i++){
      const ang = i * Math.PI/30;
      const len = (i%5===0)? 12 : 6;
      ctx.beginPath();
      const inner = r-18;
      const outer = inner - len;
      ctx.moveTo(inner*Math.cos(ang), inner*Math.sin(ang));
      ctx.lineTo((inner-len)*Math.cos(ang), (inner-len)*Math.sin(ang));
      ctx.lineWidth = (i%5===0)? 3 : 1.5;
      ctx.strokeStyle = (i%5===0)? "#94a3b8" : "#cbd5e1";
      ctx.stroke();
    }

    // 数字
    ctx.fillStyle = "#334155";
    ctx.font = `${Math.floor(r*0.22)}px system-ui, sans-serif`;
    ctx.textAlign="center"; ctx.textBaseline="middle";
    for(let n=1;n<=12;n++){
      const ang = (n-3) * Math.PI/6;
      const rr = r*0.7;
      ctx.fillText(String(n), rr*Math.cos(ang), rr*Math.sin(ang));
    }

    // 針
    
		

		const minAng  = m * Math.PI/30 - Math.PI/2;
const hourAng = ((h%12) + m/60) * Math.PI/6 - Math.PI/2;
		
    // 時針
    ctx.save();
    ctx.rotate(hourAng);
    ctx.beginPath();
    ctx.lineWidth = 6;
    ctx.lineCap="round";
    ctx.moveTo(0,0);
    ctx.lineTo(r*0.45,0);
    ctx.strokeStyle = "#111827";
    ctx.stroke();
    ctx.restore();

    // 分針
    ctx.save();
    ctx.rotate(minAng);
    ctx.beginPath();
    ctx.lineWidth = 4;
    ctx.lineCap="round";
    ctx.moveTo(0,0);
    ctx.lineTo(r*0.68,0);
    ctx.strokeStyle = "#111827";
    ctx.stroke();
    ctx.restore();

    // つまみ
    ctx.beginPath();
    ctx.arc(0,0,5,0,Math.PI*2);
    ctx.fillStyle="#111827";
    ctx.fill();

    ctx.restore();
  }

  // ==== UI ====
  const els = {
    score: byId("score"),
    streak: byId("streak"),
    miss: byId("miss"),
    best: byId("best"),
    timeText: byId("timeText"),
    choices: byId("choices"),
    next: byId("next"),
    bar: byId("bar"),
    difficulty: byId("difficulty"),
    newRound: byId("newRound"),
    resetBest: byId("resetBest"),
    howto: byId("howto"),
    toast: byId("toast")
  };

  function showToast(text){
    els.toast.textContent = text;
    els.toast.classList.add("show");
    setTimeout(()=>els.toast.classList.remove("show"), 1400);
  }

  function updateStats(){
    els.score.textContent = state.score;
    els.streak.textContent = state.streak;
    els.miss.textContent = state.miss;
    els.best.textContent = state.best;
    const pct = (state.qIndex/ROUND_QUESTIONS)*100;
    els.bar.style.width = `${pct}%`;
  }

  function speak(text){
    // 簡単な読み上げ（対応ブラウザのみ）
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "ja-JP";
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(_e){}
  }

  function newQuestion(){
    if(state.qIndex>=ROUND_QUESTIONS){
      // ラウンド終了
      els.next.disabled = true;
      const msg = `おわり！ スコア：${state.score}点（まちがい ${state.miss}回）`;
      showToast(msg);
      speak(msg);
      if(state.score>state.best){
        state.best = state.score;
        localStorage.setItem("clock.best", String(state.best));
      }
      updateStats();
      return;
    }

    els.next.disabled = true;
    // 問題作成
    const ans = randomTime(state.difficulty);
    const options = makeOptions(ans, state.difficulty);

    state.current = ans;
    state.options = options;

    // 表示
    els.timeText.textContent = fmt(ans.h, ans.m);
    renderChoices(options, ans);
    updateStats();
  }

  
	function sizeAndDraw(canvas, h, m, card){
  const rect = card.getBoundingClientRect();
  const padLR = 24; // .card の padding 左右合計 (12+12)
  const px = Math.min(360, Math.floor(rect.width - padLR)); // カード幅にフィット
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.floor(px * dpr);
  canvas.height = Math.floor(px * dpr);
  canvas.style.width = px + "px";
  canvas.style.height = px + "px";
  drawClock(canvas, h, m);
}

function renderChoices(options){
  els.choices.innerHTML = "";
  options.forEach((opt, i)=>{
    const card = document.createElement("button");
    card.className = "card";
    card.setAttribute("role","listitem");
    card.setAttribute("aria-label", `${fmt(opt.h,opt.m)} の とけい`);
    card.dataset.index = i;

    const badge = document.createElement("div");
    badge.className = "badge";
    badge.textContent = `No.${i+1}`;
    card.appendChild(badge);

    const canvas = document.createElement("canvas");
    canvas.style.width = "100%"; // レイアウト上はカード幅に合わせる
    canvas.style.height = "auto";
    canvas.style.aspectRatio = "1 / 1";
    card.appendChild(canvas);

    card.addEventListener("click", ()=> choose(i));
    els.choices.appendChild(card);

    // DOMに入れてから実寸で高解像度描画
    requestAnimationFrame(()=> sizeAndDraw(canvas, opt.h, opt.m, card));

    // リサイズ対応（列数が変わった時も再描画）
    const ro = new ResizeObserver(()=>{
      sizeAndDraw(canvas, opt.h, opt.m, card);
    });
    ro.observe(card);
  });
}

  function endQuestion(correct){
    // すべてのカードの状態を確定
    const cards = [...els.choices.querySelectorAll(".card")];
    const answerKey = `${state.current.h}:${state.current.m}`;
    cards.forEach((c, idx)=>{
      const opt = state.options[idx];
      const key = `${opt.h}:${opt.m}`;
      c.classList.add( key===answerKey ? "correct" : "wrong" );
      c.disabled = true;
    });
    els.next.disabled = false;
    state.qIndex++;
    updateStats();
  }

  function choose(index){
    const chosen = state.options[index];
    const ok = (chosen.h===state.current.h && chosen.m===state.current.m);
    if(ok){
      const bonus = POINT_BASE + (state.streak*POINT_STREAK);
      state.score += bonus;
      state.streak += 1;
      showToast(`せいかい！ +${bonus}点（れんぞく +${state.streak*POINT_STREAK}）`);
      speak("せいかいだよ、ハートがすきな、たけだめいちゃん！");
    }else{
      state.score = clamp(0, state.score - PENALTY_WRONG, 99999);
      state.streak = 0;
      state.miss += 1;
      showToast(`ちがうよ… -${PENALTY_WRONG}点`);
      speak("ちがうよ、むらさきがすきな、たけだめいちゃん");
    }
    endQuestion(ok);
		  // ★正解時のみ、自動で次の問題へ（重複遷移を防ぐため一時的にNextを無効化）
  if(ok){
    els.next.disabled = true;
    setTimeout(()=>{ newQuestion(); }, 900); // 表示確認のため少し待つ
  }

  }

  // ==== イベント ====
  els.next.addEventListener("click", newQuestion);
  els.newRound.addEventListener("click", ()=>{
    state.qIndex=0; state.score=0; state.streak=0; state.miss=0;
    newQuestion();
  });
  els.resetBest.addEventListener("click", ()=>{
    localStorage.removeItem("clock.best");
    state.best = 0;
    updateStats();
    showToast("ベストスコアを けしました");
  });
  els.howto.addEventListener("click", ()=>{
    alert([
      "【あそびかた】",
      "1) まんなかの じこく と おなじ とけい を えらぼう！",
      "2) せいかい なら 10点 + れんぞくボーナス！",
      "3) まちがえる と -5点。10問で しゅうりょう！",
      "4) 難易度は 右上から 変えられるよ。"
    ].join("\n"));
  });
  els.difficulty.value = state.difficulty;
  els.difficulty.addEventListener("change", (e)=>{
    state.difficulty = e.target.value;
    localStorage.setItem("clock.diff", state.difficulty);
    showToast(`難易度：${e.target.selectedOptions[0].textContent}`);
  });

  // キーボード（1-4）
  document.addEventListener("keydown", (e)=>{
    if(["1","2","3","4"].includes(e.key) && !els.next.disabled){
      // まだ回答前
      const idx = Number(e.key)-1;
      const btn = els.choices.querySelectorAll(".card")[idx];
      if(btn) btn.click();
    } else if(e.key==="Enter" && !els.next.disabled){
      els.next.click();
    }
  });

  // 初期表示
  updateStats();
  newQuestion();
})();
</script>
</body>
</html>
